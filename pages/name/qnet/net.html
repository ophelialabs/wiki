@page "/Networks"
@using System.Net.Http
@inject IJSRuntime JS
@implements IAsyncDisposable

<PageTitle>Quantum Network Visualization</PageTitle>

<link rel="stylesheet" href="/css/networks.css" />

<div class="networks-container">
    <!-- Header -->
    <div class="networks-header">
        <h1>üåê Quantum Networks & Connectivity</h1>
        <p class="subtitle">Real-time visualization of quantum computing networks and entanglement links</p>
    </div>

    <!-- Controls -->
    <div class="networks-controls">
        <button class="control-btn @(viewMode == "globe" ? "active" : "")" @onclick="@((e) => SwitchView("globe"))">
            üåç 3D Globe View
        </button>
        <button class="control-btn @(viewMode == "network" ? "active" : "")" @onclick="@((e) => SwitchView("network"))">
            üîó Network Topology
        </button>
        <button class="control-btn @(viewMode == "details" ? "active" : "")" @onclick="@((e) => SwitchView("details"))">
            üìä Network Details
        </button>
        <div class="status-indicator">
            <span class="status-dot @(isOnline ? "online" : "offline")"></span>
            <span>Network Status: @(isOnline ? "ACTIVE" : "OFFLINE")</span>
        </div>
    </div>

    <!-- Loading State -->
    @if (isLoading)
    {
        <div class="loading-container">
            <div class="spinner"></div>
            <p>Loading quantum network data...</p>
        </div>
    }
    else
    {
        <!-- 3D Globe View -->
        @if (viewMode == "globe")
        {
            <div class="view-container globe-view">
                <div id="globe-canvas" class="globe-canvas"></div>
                <div class="globe-info">
                    <h3>Quantum Hub: @(currentNode?.Name ?? "Chattanooga QNet")</h3>
                    <div class="node-status">
                        <p><strong>Status:</strong> @(networkState?.NodeStatus ?? "Active")</p>
                        <p><strong>Entanglement Rate:</strong> @(networkState?.EntanglementRate ?? "N/A")</p>
                        <p><strong>Fidelity:</strong> @(networkState?.Fidelity.ToString("P2") ?? "N/A")</p>
                        <p><strong>QKD Rate:</strong> @(networkState?.QkdRate ?? "N/A")</p>
                    </div>
                </div>
            </div>
        }

        <!-- Network Topology View -->
        @if (viewMode == "network")
        {
            <div class="view-container topology-view">
                <div class="topology-grid">
                    <div class="topology-center">
                        <div class="node central-node">
                            <div class="node-icon">‚öõÔ∏è</div>
                            <div class="node-label">Chattanooga<br/>Quantum Hub</div>
                        </div>
                    </div>

                    <!-- Connected Nodes -->
                    <div class="connections">
                        @foreach (var link in quantumLinks)
                        {
                            <div class="connection-line" style="--angle: @(link.Index * 90)deg;"></div>
                            <div class="remote-node" style="--angle: @(link.Index * 90)deg;">
                                <div class="node">
                                    <div class="node-icon">üîó</div>
                                    <div class="node-label">@link.Target?.Name</div>
                                    <div class="link-status @link.Status.ToLower()">@link.Status</div>
                                    <div class="link-type">@link.Type</div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        }

        <!-- Network Details View -->
        @if (viewMode == "details")
        {
            <div class="view-container details-view">
                <div class="details-grid">
                    <!-- Central Hub Details -->
                    <div class="detail-card hub-card">
                        <h3>Central Hub - Chattanooga QNet</h3>
                        <div class="card-content">
                            <div class="capability-list">
                                <h4>Capabilities</h4>
                                <ul>
                                    <li>‚úì Quantum Key Distribution</li>
                                    <li>‚úì Entanglement Distribution</li>
                                    <li>‚úì Quantum Memory Storage</li>
                                </ul>
                            </div>
                            <div class="connection-list">
                                <h4>Active Connections</h4>
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Type</th>
                                            <th>Capacity</th>
                                            <th>Range</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>Fiber</td>
                                            <td>100 quantum bits/sec</td>
                                            <td>100km</td>
                                        </tr>
                                        <tr>
                                            <td>Satellite</td>
                                            <td>10 quantum bits/sec</td>
                                            <td>GEO orbit</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Network Statistics -->
                    <div class="detail-card stats-card">
                        <h3>Network Statistics</h3>
                        <div class="stats-grid">
                            <div class="stat-item">
                                <span class="stat-label">Node Status</span>
                                <span class="stat-value">@(networkState?.NodeStatus ?? "N/A")</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Entanglement Rate</span>
                                <span class="stat-value">@(networkState?.EntanglementRate ?? "N/A")</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Network Fidelity</span>
                                <span class="stat-value">@(networkState?.Fidelity.ToString("P2") ?? "N/A")</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">QKD Transfer Rate</span>
                                <span class="stat-value">@(networkState?.QkdRate ?? "N/A")</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Active Links</span>
                                <span class="stat-value">@(quantumLinks?.Count ?? 0)</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Last Updated</span>
                                <span class="stat-value">@lastUpdateTime.ToString("HH:mm:ss")</span>
                            </div>
                        </div>
                    </div>

                    <!-- Connected Nodes Details -->
                    @foreach (var link in quantumLinks)
                    {
                        <div class="detail-card node-card">
                            <h3>@(link.Target?.Name ?? "Unknown Node")</h3>
                            <div class="card-content">
                                <p><strong>Location:</strong> @(link.Target?.Lat.ToString("F4") ?? "N/A"), @(link.Target?.Lng.ToString("F4") ?? "N/A")</p>
                                <p><strong>Connection Type:</strong> <span class="connection-type">@link.Type.ToUpper()</span></p>
                                <p><strong>Status:</strong> <span class="status-badge @link.Status.ToLower()">@link.Status</span></p>
                                <p><strong>Network Speed:</strong> High-speed quantum entanglement channel</p>
                            </div>
                        </div>
                    }
                </div>
            </div>
        }
    }

    <!-- Action Buttons -->
    <div class="action-buttons">
        <button class="action-btn refresh-btn" @onclick="RefreshNetworkData">üîÑ Refresh Data</button>
        <button class="action-btn export-btn" @onclick="ExportNetworkData">üì• Export Report</button>
    </div>
</div>

<!-- Three.js Library for 3D Globe -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="/js/quantum-globe.js"></script>

@code {
    private string viewMode = "globe";
    private bool isLoading = true;
    private bool isOnline = true;
    private DateTime lastUpdateTime = DateTime.Now;

    private QuantumNodeDto? currentNode;
    private QuantumNetworkStateDto? networkState;
    private List<QuantumLinkDto> quantumLinks = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadNetworkData();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && viewMode == "globe")
        {
            await InitializeGlobe();
        }
    }

    private async Task LoadNetworkData()
    {
        isLoading = true;
        try
        {
            // Load quantum network data from API
            quantumLinks = new List<QuantumLinkDto>
            {
                new QuantumLinkDto
                {
                    Index = 0,
                    Source = new LocationDto { Lat = 35.0456, Lng = -85.3097, Name = "Chattanooga QNet" },
                    Target = new LocationDto { Lat = 35.9606, Lng = -83.9207, Name = "Oak Ridge" },
                    Type = "fiber",
                    Status = "active"
                },
                new QuantumLinkDto
                {
                    Index = 1,
                    Source = new LocationDto { Lat = 35.0456, Lng = -85.3097, Name = "Chattanooga QNet" },
                    Target = new LocationDto { Lat = 33.7490, Lng = -84.3880, Name = "Atlanta" },
                    Type = "fiber",
                    Status = "active"
                },
                new QuantumLinkDto
                {
                    Index = 2,
                    Source = new LocationDto { Lat = 35.0456, Lng = -85.3097, Name = "Chattanooga QNet" },
                    Target = new LocationDto { Lat = 36.1627, Lng = -86.7816, Name = "Nashville" },
                    Type = "satellite",
                    Status = "inactive"
                }
            };

            currentNode = new QuantumNodeDto
            {
                Name = "Chattanooga QNet",
                Lat = 35.0456,
                Lng = -85.3097,
                Type = "QUANTUM_HUB",
                Capabilities = new CapabilitiesDto
                {
                    QuantumKeyDistribution = true,
                    EntanglementDistribution = true,
                    QuantumMemory = true
                }
            };

            networkState = new QuantumNetworkStateDto
            {
                NodeStatus = "active",
                EntanglementRate = "1000 pairs/second",
                Fidelity = 0.98,
                QkdRate = "100 kbps"
            };

            lastUpdateTime = DateTime.Now;
            isOnline = true;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading network data: {ex.Message}");
            isOnline = false;
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task InitializeGlobe()
    {
        try
        {
            // Ensure DOM element exists
            await Task.Delay(50);
            await JS.InvokeVoidAsync("initializeQuantumGlobe", quantumLinks);
            Console.WriteLine("Globe initialization called successfully");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error initializing globe: {ex.Message}");
        }
    }

    private async Task SwitchView(string mode)
    {
        // Dispose previous globe if switching away
        if (viewMode == "globe" && mode != "globe")
        {
            await JS.InvokeVoidAsync("disposeQuantumGlobe");
        }

        viewMode = mode;
        StateHasChanged();
        
        if (mode == "globe")
        {
            // Small delay to ensure DOM is updated
            await Task.Delay(100);
            await InitializeGlobe();
        }
    }

    private async Task RefreshNetworkData()
    {
        await LoadNetworkData();
        StateHasChanged();
    }

    private void ExportNetworkData()
    {
        // Export network data as JSON or CSV
        Console.WriteLine("Exporting network data...");
    }

    async ValueTask IAsyncDisposable.DisposeAsync()
    {
        try
        {
            await JS.InvokeVoidAsync("disposeQuantumGlobe");
        }
        catch
        {
            // Ignore errors during disposal
        }
        await Task.CompletedTask;
    }

    // DTOs
    public class QuantumNodeDto
    {
        public string Name { get; set; } = "";
        public double Lat { get; set; }
        public double Lng { get; set; }
        public string Type { get; set; } = "";
        public CapabilitiesDto? Capabilities { get; set; }
    }

    public class CapabilitiesDto
    {
        public bool QuantumKeyDistribution { get; set; }
        public bool EntanglementDistribution { get; set; }
        public bool QuantumMemory { get; set; }
    }

    public class QuantumNetworkStateDto
    {
        public string NodeStatus { get; set; } = "";
        public string EntanglementRate { get; set; } = "";
        public double Fidelity { get; set; }
        public string QkdRate { get; set; } = "";
    }

    public class QuantumLinkDto
    {
        public int Index { get; set; }
        public LocationDto? Source { get; set; }
        public LocationDto? Target { get; set; }
        public string Type { get; set; } = "";
        public string Status { get; set; } = "";
    }

    public class LocationDto
    {
        public double Lat { get; set; }
        public double Lng { get; set; }
        public string Name { get; set; } = "";
    }
}
